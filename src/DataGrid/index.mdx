---
name: DataGrid(数据表格)
route: /DataGrid
menu: 'components'
---

import { Playground, Props } from 'docz';
import 'antd/dist/antd.css';
import { useState } from 'react'
import { Button, Input} from 'antd';
import { DataGrid, BaseGrid } from './';
import Decision from '../Show/Decision.tsx'

# DataGrid(数据表格)

支持 url 保存查询参数(方便 goback 保留查询条件)

> 该 Gird 是对 [ag-grid](https://www.ag-grid.com/documentation-main/documentation.php) 开源版的封装
> ,具体的 api 请去 [ag-grid](https://www.ag-grid.com/documentation-main/documentation.php) 查看文档

## 基本用法(Basic usage)

<Playground>
  {() => {
    const columnDefs = [
      {
        headerName: '姓名',
        field: 'realName',
      },
      {
        headerName: '电话',
        field: 'mobile',
      },
      {
        headerName: '邮箱',
        field: 'email',
      },
      {
        headerName: '角色',
        field: 'roleValue',
      },
      {
        headerName: '用户id',
        field: 'userId',
      },
      {
        headerName: '电话',
        field: 'tel',
      },
      {
        headerName: '性别',
        field: 'gender',
      },
    ];
    return (
      <div style={{ height: 500 }}>
        <DataGrid
          firstLoad={false}
          columnDefs={columnDefs}
          fetchUrl="/api/user/personManage/"
        />
      </div>
    );
  }}
</Playground>

## 属性(Properties)

```ts
export interface DataGridProps
  extends Omit<BaseGridProps, 'suppressMultiSort' | 'className'> {
  /**
   * 默认单页显示条数
   */
  pageSize?: number;
  /**
   * 默认页数
   */
  page?: number;
  total?: number;
  error?: Error;
  onPaginationChange?(page: number, pageSize?: number): void;
  /**
   * 单页显示条数候选项
   */
  pageSizeOptions?: string[];
  className?: string;
  gridClassName?: string;
  /**
   * 默认列参数,由于ag-grid server模式下的排序bug这个参数做了fix
   */
  defaultColDef?: ColDef;

  /**
   * 支持分页
   * @default true
   */
  supportPagination?: boolean;
  /**
   * 排序模型
   */
  sorters?: SortModelItem[];
}
```

## 实现一个useSearch

```typeScript
import { Pagination, PaginationBody, Sort } from '@/models/Pagination';
import { ReqResponse } from '@/utils/request';
import { useCallback, useMemo, useRef } from 'react';
import { useHistory, useLocation } from 'react-router';
import { GridApi, SortModelItem } from 'ag-grid-community';
import useSWR, { SWRConfiguration } from 'swr';
import qs from 'qs';
import usePureFetch from './usePureFetch';
import { useQuery } from './useQuery';
import useValue from './useValue';

export function getQueryParse<T>(
  key?: string,
  query?: Record<string, any>,
  defaultValue?: T,
): T | undefined {
  if (!key) return defaultValue;
  if (!query) return defaultValue;
  if (!query[key]) return defaultValue;
  const search = JSON.parse(query[key]);
  return search;
}

export function useQueryData(
  key?: string,
  // 默认查询参数
  defaultValue?: PaginationBody,
) {
  const query = useQuery();
  const location = useLocation();
  const history = useHistory();
  const queryDataV = useValue(() => {
    return getQueryParse(key, query, defaultValue);
  });

  const setQuery = useCallback((body: PaginationBody) => {
    queryDataV.setValue({
      ...queryDataV.value,
      ...body,
    });
    if (key) {
      history.replace({
        pathname: location.pathname,
        state: location.state,
        search: qs.stringify({
          ...query,
          [key]: JSON.stringify(queryDataV.value),
        }),
      });
    }
  }, []);

  const resetQuery = useCallback(() => {
    queryDataV.setValue(defaultValue);
  }, [defaultValue]);

  return {
    queryDataV,
    query: queryDataV.value,
    setQuery,
    resetQuery,
  };
}

export default function useSearch<T = unknown>(
  key: string,
  fetch: (body: PaginationBody) => Promise<ReqResponse<Pagination<T>>>,
  defaultValue?: PaginationBody,
  // 默认查询参数
  swrconfig?: SWRConfiguration<Pagination<T>>,
) {
  const queryDataProps = useQueryData(key, defaultValue);
  const sorters = useRef<SortModelItem[] | undefined>(
    queryDataProps.query?.sort,
  );
  const newFetch = useCallback(
    (body: string) => {
      return fetch(JSON.parse(body));
    },
    [fetch],
  );

  const queryStr = useMemo(() => {
    return JSON.stringify(queryDataProps.query);
  }, [queryDataProps.query]);

  const swrProps = useSWR(
    [key, queryStr],
    usePureFetch(newFetch, true),
    swrconfig,
  );
  const onPaginationChange = useCallback(
    (page: number, pageSize?: number) => {
      queryDataProps.setQuery({ page, pageSize });
    },
    [queryDataProps.setQuery],
  );

  const onSortChanged = useCallback(
    ({ api }: { api: GridApi }) => {
      const sortModal = api.getSortModel();
      if (queryDataProps.queryDataV.value?.sort?.length === sortModal.length) {
        // 浅对比
        if (queryDataProps.queryDataV.value.sort.length === 0) {
          return;
        }
        // 深对比
        if (
          queryDataProps.queryDataV.value.sort.every((sorter) =>
            sortModal.some(
              (item) =>
                item.colId === sorter.colId && item.sort === sorter.sort,
            ),
          )
        ) {
          return;
        }
      }
      queryDataProps.setQuery({
        sort: sortModal as Sort[],
      });
      sorters.current = sortModal as Sort[];
    },
    [queryDataProps.setQuery],
  );
  const reload = useCallback(() => {
    swrProps.mutate();
  }, [swrProps.mutate, key, queryStr]);
  return {
    ...queryDataProps,
    ...swrProps,
    reload,
    gridProps: {
      onPaginationChange,
      page: queryDataProps.query?.page,
      pageSize: queryDataProps.query?.pageSize,
      total: swrProps.data?.total,
      rowData: swrProps.data?.items,
      onSortChanged,
      error: swrProps.error,
      sorters: sorters.current,
    },
  };
}
```

# BaseGrid

## 基本用法(Basic usage)

<Playground>
  {() => {
    
    const columnDefs = [
      {
        headerName: '姓名',
        field: 'realName',
      },
      {
        headerName: '电话',
        field: 'mobile',
      },
      {
        headerName: '邮箱',
        field: 'email',
      },
      {
        headerName: '角色',
        field: 'roleValue',
      },
      {
        headerName: '用户id',
        field: 'userId',
      },
      {
        headerName: '电话',
        field: 'tel',
        cellRendererFramework: ({ value }) => {
          // 测试是否支持上下文
          const [tel,setTel] = useState(value)
          console.log(tel)
          return <div>
            <Decision.Case expect={(v) => v!==tel}>
              <Input size="small" value={tel} onChange={(e) => setTel(e.target.value)}/>
            </Decision.Case>
            <Decision.Case expect={tel}>
              {tel}
            </Decision.Case>
          </div>
        }
      },
      {
        headerName: '性别',
        field: 'gender',
      },
    ];

    return (
      <div style={{ height: 500 }}>
        <Decision actual="123">
          <BaseGrid columnDefs={columnDefs} rowData={[{"realName":"schoolAdmin","userStatusCode":1,"roleValue":"校级管理员","gender":0,"userAccount":"schoolAdmin","mobile":null,"userDesc":null,"tel":"123","userId":"b6897cd7-356f-42c7-abd2-ea0ece366f97","userStatusValue":"可用","email":null},{"realName":"admin","userStatusCode":1,"roleValue":"admin","gender":0,"userAccount":"admin","mobile":null,"userDesc":null,"tel":null,"userId":"admin","userStatusValue":"可用","email":"xxx@qq.com"},{"realName":"联调老师（勿动）","userStatusCode":1,"roleValue":"校长","gender":1,"userAccount":"xz","mobile":null,"userDesc":null,"tel":null,"userId":"xld","userStatusValue":"可用","email":"xxx@qq.com"}]} />
        </Decision>
      </div>
    );

}}

</Playground>

<Playground>
  {() => {
    
    const columnDefs = [
      {
        headerName: '姓名',
        field: 'realName',
      },
      {
        headerName: '电话',
        field: 'mobile',
      },
      {
        headerName: '邮箱',
        field: 'email',
      },
      {
        headerName: '角色',
        field: 'roleValue',
      },
      {
        headerName: '用户id',
        field: 'userId',
      },
      {
        headerName: '电话',
        field: 'tel',
        cellRendererFramework: ({ value }) => {
          // 测试是否支持上下文
          const [tel,setTel] = useState(value)
          console.log(tel)
          return <div>
            <Decision.Case expect={(v) => v!==tel}>
              <Input size="small" value={tel} onChange={(e) => setTel(e.target.value)}/>
            </Decision.Case>
            <Decision.Case expect={tel}>
              {tel}
            </Decision.Case>
          </div>
        }
      },
      {
        headerName: '性别',
        field: 'gender',
      },
    ];

    return (
      <div style={{ height: 500 }}>
        <Decision actual="123">
          <BaseGrid columnDefs={columnDefs} 
          rowData={[
            {
              realName: 'schoolAdmin',
              userStatusCode: 1,
              roleValue: '校级管理员',
              gender: 0,
              userAccount: 'schoolAdmin',
              mobile: null,
              userDesc: null,
              tel: '123',
              userId: 'b6897cd7-356f-42c7-abd2-ea0ece366f97',
              userStatusValue: '可用',
              email: null,
            },
            {
              realName: 'admin',
              userStatusCode: 1,
              roleValue: 'admin',
              gender: 0,
              userAccount: 'admin',
              mobile: null,
              userDesc: null,
              tel: null,
              userId: 'admin',
              userStatusValue: '可用',
              email: 'xxx@qq.com',
            },
            {
              realName: '联调老师（勿动）',
              userStatusCode: 1,
              roleValue: '校长',
              gender: 1,
              userAccount: 'xz',
              mobile: null,
              userDesc: null,
              tel: null,
              userId: 'xld',
              userStatusValue: '可用',
              email: 'xxx@qq.com',
            },
            {
              realName: '联调老师（勿动）',
              userStatusCode: 1,
              roleValue: '校长',
              gender: 1,
              userAccount: 'xz',
              mobile: null,
              userDesc: null,
              tel: null,
              userId: 'xld',
              userStatusValue: '可用',
              email: 'xxx@qq.com',
            },
            {
              realName: '联调老师（勿动）',
              userStatusCode: 1,
              roleValue: '校长',
              gender: 1,
              userAccount: 'xz',
              mobile: null,
              userDesc: null,
              tel: null,
              userId: 'xld',
              userStatusValue: '可用',
              email: 'xxx@qq.com',
            },
            {
              realName: '联调老师（勿动）',
              userStatusCode: 1,
              roleValue: '校长',
              gender: 1,
              userAccount: 'xz',
              mobile: null,
              userDesc: null,
              tel: null,
              userId: 'xld',
              userStatusValue: '可用',
              email: 'xxx@qq.com',
            },
            {
              realName: '联调老师（勿动）',
              userStatusCode: 1,
              roleValue: '校长',
              gender: 1,
              userAccount: 'xz',
              mobile: null,
              userDesc: null,
              tel: null,
              userId: 'xld',
              userStatusValue: '可用',
              email: 'xxx@qq.com',
            },
            {
              realName: '联调老师（勿动）',
              userStatusCode: 1,
              roleValue: '校长',
              gender: 1,
              userAccount: 'xz',
              mobile: null,
              userDesc: null,
              tel: null,
              userId: 'xld',
              userStatusValue: '可用',
              email: 'xxx@qq.com',
            },
            {
              realName: '联调老师（勿动）',
              userStatusCode: 1,
              roleValue: '校长',
              gender: 1,
              userAccount: 'xz',
              mobile: null,
              userDesc: null,
              tel: null,
              userId: 'xld',
              userStatusValue: '可用',
              email: 'xxx@qq.com',
            },
          ]} 
          footerGrid={{
            rowData: [
              {
                realName: '3人',
                mobile: "test",
              },
              {
                realName: '测试第二行',
              },
            ]
          }}/>
        </Decision>
      </div>
    );

}}

</Playground>

## 属性(Properties)


<Props of={BaseGrid} />
